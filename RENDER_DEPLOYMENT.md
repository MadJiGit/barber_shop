# Render Deployment Guide - Barber Shop

## Prerequisites

1. **Render Account** - Sign up at https://render.com
2. **GitHub Repository** - Push your code to GitHub
3. **PostgreSQL Database** - Will be created in Render

---

## Deployment Steps

### Step 1: Connect GitHub Repository to Render

1. Go to https://dashboard.render.com
2. Click **"New +"** → **"Blueprint"**
3. Connect your GitHub account
4. Select the repository: `barber_shop`
5. Click **"Apply"**

Render will automatically detect `render.yaml` and create:
- **PostgreSQL Database** (`barber-shop-db`)
- **Web Service** (`barber-shop-web`)

---

### Step 2: Configure Environment Variables

Render will auto-generate most variables, but you need to manually set:

#### In Web Service (`barber-shop-web`):

| Variable | Value |
|----------|-------|
| `MAILER_DSN` | `smtp://username:password@smtp.example.com:587` |
| `MAILER_NOREPLY_EMAIL` | `reg9643@gmail.com` |
| `MAILER_NOREPLY_NAME` | `Barber Shop` |

**To add MAILER_DSN:**
1. Go to **Dashboard** → **barber-shop-web** → **Environment**
2. Add `MAILER_DSN` with your SMTP credentials
3. Click **"Save Changes"**

---

### Step 3: Database Initialization

The PostgreSQL database will automatically:
1. **Create tables** - Via Doctrine migrations (executed in `docker-entrypoint.sh`)
2. **Load seed data** - Via SQL files in `data/` directory:
   - `01_barbers.sql` - Creates 4 users (Super Admin, Admin, Senior Barber, Barber)
   - `02_procedures.sql` - Creates 16 procedures/services

**Verification:**
```bash
# After deployment, check logs in Render dashboard
# You should see:
# "Running Doctrine migrations..."
# "Migrations applied successfully"
```

---

### Step 4: Access Your Application

Once deployment completes:
1. Render provides a URL: `https://barber-shop-web.onrender.com`
2. Visit the URL to see your application

**Default Login Credentials:**
- **Super Admin**: `super_admin@abv.bg` / `12345678`
- **Admin**: `admin@abv.bg` / `12345678`
- **Senior Barber**: `barber_senior@abv.bg` / `12345678`
- **Barber**: `barber@abv.bg` / `12345678`

---

## File Structure for Render

```
barber_shop/
├── render.yaml              ← Render configuration
├── Dockerfile               ← Main application container
├── Dockerfile.postgres      ← PostgreSQL with seed data
├── docker-entrypoint.sh     ← Startup script (runs migrations)
├── docker-compose.yml       ← Local development
├── .dockerignore            ← Files to exclude from build
├── data/
│   ├── barbers_postgres.sql    ← User/barber seed data
│   └── procedures_postgres.sql ← Procedures seed data
└── ...
```

---

## Important Notes

### 1. Free Tier Limitations
- **Web Service**: Spins down after 15 minutes of inactivity
- **Database**: 1GB storage limit
- **Build Time**: ~5-10 minutes

### 2. Environment Variables
- `APP_SECRET` - Auto-generated by Render
- `DATABASE_URL` - Auto-generated from database connection
- `MAILER_DSN` - **MUST be set manually** (see Step 2)

### 3. Migrations
- Migrations run automatically on each deployment
- Idempotent: Safe to run multiple times
- Location: `migrations/` directory

### 4. SQL Seed Files
- **Only execute once** on first database initialization
- If database already has data, they are skipped
- Loaded in alphabetical order: `01_barbers.sql` → `02_procedures.sql`

---

## Troubleshooting

### Issue: "Database connection failed"
**Solution:**
1. Check that `DATABASE_URL` is correctly set (auto-generated)
2. Verify PostgreSQL service is running
3. Check logs in Render dashboard

### Issue: "Migrations failed"
**Solution:**
1. Check migration files in `migrations/` directory
2. View logs: `Dashboard → barber-shop-web → Logs`
3. Manually run: `php bin/console doctrine:migrations:migrate`

### Issue: "No users in database"
**Solution:**
1. Check if `data/barbers_postgres.sql` is in repository
2. Verify `Dockerfile.postgres` copies SQL files
3. Re-create database service to trigger initialization

### Issue: "CSS/JS not loading"
**Solution:**
1. Check if `public/build/` directory exists after build
2. Verify Webpack compiled assets in build stage
3. Check Apache configuration in Dockerfile

---

## Manual Deployment (Alternative)

If Blueprint deployment fails, deploy manually:

### 1. Create PostgreSQL Database
```
Dashboard → New + → PostgreSQL
Name: barber-shop-db
Region: Frankfurt
Plan: Free
```

### 2. Create Web Service
```
Dashboard → New + → Web Service
Source: Docker
Repository: your-repo/barber_shop
Branch: main
Dockerfile Path: ./Dockerfile
Region: Frankfurt
Plan: Free
```

### 3. Link Database
```
Environment Variables:
DATABASE_URL = [Copy from PostgreSQL service]
```

---

## Post-Deployment Checklist

- [ ] Application loads without errors
- [ ] Can login with default credentials
- [ ] Database has 4 users and 16 procedures
- [ ] Email notifications work (test registration)
- [ ] Guest booking works
- [ ] CSS/JS assets load correctly
- [ ] Apache serves pages without 500 errors

---

## Updating the Application

When you push new code to GitHub:
1. Render automatically detects changes
2. Rebuilds Docker image
3. Runs migrations
4. Restarts web service

**Note**: Database seed files only run on first initialization, NOT on updates.

---

## Backup & Restore

### Backup Database
```bash
# In Render dashboard
Database → barber-shop-db → Backups → Create Backup
```

### Restore Database
```bash
# Download backup from Render
# Restore using psql or pgAdmin
psql -h [hostname] -U [user] -d barber_shop < backup.sql
```

---

## Monitoring

- **Logs**: Dashboard → Web Service → Logs
- **Metrics**: Dashboard → Web Service → Metrics
- **Database**: Dashboard → PostgreSQL → Metrics

---

## Support

- **Render Docs**: https://render.com/docs
- **Symfony Docs**: https://symfony.com/doc/current/index.html
- **Docker Docs**: https://docs.docker.com/

---

Last Updated: 2025-12-10
