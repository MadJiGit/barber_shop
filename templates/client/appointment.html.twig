{% extends 'base.html.twig' %}

{% block title %}{{ 'appointment.title' | trans }}{% endblock %}

{% block body %}
    <!--? Hero Start -->
    <div class="slider-area2">
        <div class="slider-height2 d-flex align-items-center">
            <div class="container">
                <div class="row">
                    <div class="col-xl-12">
                        <div class="hero-cap hero-cap2 pt-70 text-center">
                            <h2>{{ 'appointment.hero_title' | trans }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Hero End -->

    <!--? Appointment Booking Section Start -->
    <section class="appointment-booking-section section-padding30">
        <div class="container">
            {% if user or isGuest %}
                <div class="row justify-content-center">
                    <div class="col-xl-11 col-lg-12">
                        <!-- Section Title -->
                        <div class="section-tittle text-center mb-50">
                            <h2>{{ 'appointment.section.choose_range' | trans }}</h2>
                        </div>

                        <!-- Appointment Form -->
                        <form id="appointment_form"
                              method="post"
                              class="appointment-form-new"
                              data-turbo="false">
                            {{ form_row(form._token) }}

                            <!-- Hidden inputs for form submission -->
                            <input type="hidden" name="barbers" id="selected_barber_id" value=""/>
                            <input type="hidden" name="procedures" id="selected_procedure_id" value=""/>
                            <input type="hidden" name="appointment_start" id="selected_appointment_date" value="{{ today }}"/>
                            <input type="hidden" name="pickedHours" id="pickedHours" value=""/>

                            {% if isGuest %}
                                <!-- Guest Contact Information -->
                                <div class="row mb-50">
                                    <div class="col-12">
                                        <div class="guest-info-section">
                                            <h4 class="form-section-title text-center mb-30">
                                                <i class="fas fa-user"></i> {{ 'appointment.guest.title' | trans }}
                                            </h4>
                                            <div class="row">
                                                <div class="col-md-6 mb-20">
                                                    <label for="guest_first_name" class="form-label">{{ 'appointment.guest.first_name' | trans }} *</label>
                                                    <input type="text"
                                                           class="form-control"
                                                           id="guest_first_name"
                                                           name="guest_first_name"
                                                           required
                                                           placeholder="{{ 'appointment.guest.first_name_placeholder' | trans }}">
                                                </div>
                                                <div class="col-md-6 mb-20">
                                                    <label for="guest_last_name" class="form-label">{{ 'appointment.guest.last_name' | trans }} *</label>
                                                    <input type="text"
                                                           class="form-control"
                                                           id="guest_last_name"
                                                           name="guest_last_name"
                                                           required
                                                           placeholder="{{ 'appointment.guest.last_name_placeholder' | trans }}">
                                                </div>
                                                <div class="col-md-6 mb-20">
                                                    <label for="guest_email" class="form-label">{{ 'appointment.guest.email' | trans }} *</label>
                                                    <input type="email"
                                                           class="form-control"
                                                           id="guest_email"
                                                           name="guest_email"
                                                           required
                                                           placeholder="your@email.com">
                                                </div>
                                                <div class="col-md-6 mb-20">
                                                    <label for="guest_phone" class="form-label">{{ 'appointment.guest.phone' | trans }} *</label>
                                                    <input type="tel"
                                                           class="form-control"
                                                           id="guest_phone"
                                                           name="guest_phone"
                                                           required
                                                           placeholder="{{ 'appointment.guest.phone_placeholder' | trans }}">
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-check">
                                                        <input type="checkbox"
                                                               class="form-check-input"
                                                               id="gdpr_consent"
                                                               name="gdpr_consent"
                                                               required>
                                                        <label class="form-check-label" for="gdpr_consent">
                                                            // TODO css + color to text Privacy Policy link
                                                            {{ 'appointment.guest.gdpr' | trans|raw }} *
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="row">
                                <!-- Procedure Selection -->
                                <div class="col-lg-12 mb-40">
                                    <div class="form-section text-center">
                                        <h4 class="form-section-title justify-content-center">
                                            <i class="fas fa-cut"></i> {{ 'appointment.procedure.title' | trans }}
                                        </h4>
                                        <div class="procedure-select-wrapper">
                                            <select name="procedure_select" id="procedure_select" class="custom-select-new" onchange="handleProcedureChange()">
                                                <option value="">{{ 'appointment.procedure.placeholder' | trans }}</option>
                                                {% for procedure in procedures %}
                                                    <option value="{{ procedure.id }}"
                                                            data-duration-master="{{ procedure.durationMaster }}"
                                                            data-duration-junior="{{ procedure.durationJunior }}"
                                                            data-price-master="{{ procedure.priceMaster }}"
                                                            data-price-junior="{{ procedure.priceJunior }}"
                                                            data-procedure-name="{{ procedure.type }}">
                                                        {{ procedure.type }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Date Selection -->
                                <div class="col-lg-12 mb-40">
                                    <div class="form-section text-center">
                                        <h4 class="form-section-title mb-20">{{ 'appointment.date.title' | trans }}:</h4>
                                        <div class="date-control-wrapper-new">
                                            <button class="date-arrow-btn-new" type="button" onclick="changeDate(-1)">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <input class="date-display-new"
                                                   type="text"
                                                   id="calendar_display"
                                                   value="{{ today|date('d-m-Y') }}"
                                                   autocomplete="off"
                                            />
                                            <button class="date-arrow-btn-new" type="button" onclick="changeDate(1)">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                        <div class="day-of-week-display" id="day_of_week">
                                            {% set dayNames = {
                                                0: ('appointment.days.sun'|trans),
                                                1: ('appointment.days.mon'|trans),
                                                2: ('appointment.days.tue'|trans),
                                                3: ('appointment.days.wed'|trans),
                                                4: ('appointment.days.thu'|trans),
                                                5: ('appointment.days.fri'|trans),
                                                6: ('appointment.days.sat'|trans)
                                            } %}
                                            {{ dayNames[today|date('w')] }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Barbers with Time Slots -->
                                <div class="col-lg-12" id="barbers_container">
                                    {# Barber sections will be generated dynamically by JavaScript #}
                                    <div id="barbers-container">
                                        <div class="text-center text-muted p-4">
                                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                            <p>{{ 'appointment.loading_slots' | trans }}</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="col-lg-12 text-center mt-50">
                                    <button type="submit"
                                            class="btn btn-primary btn-lg"
                                            id="submit_btn"
                                            disabled
                                            name="submit_appointment"
                                            value="1">
                                        <i class="fas fa-check"></i> {{ 'appointment.actions.submit' | trans }}
                                    </button>
                                    <div class="selection-summary mt-3" id="selection_summary">
                                        <small class="text-muted">{{ 'appointment.hint.select_service_time' | trans }}</small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <!-- User needs to complete profile -->
                <div class="row justify-content-center">
                    <div class="col-lg-8 text-center">
                        <div class="alert alert-warning">
                            <h4>{{ 'appointment.profile_incomplete.title' | trans }}</h4>
                            <p>{{ 'appointment.profile_incomplete.text' | trans }}</p>
                            <a href="{{ path('profile_edit', {id: app.user.id}) }}" class="btn btn-primary mt-3">
                                {{ 'appointment.profile_incomplete.button' | trans }}
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>
    <!-- Appointment Booking Section End -->

{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/client_appointment.css') }}">
{% endblock %}


{% block javascripts %}
    {{ parent() }}
    {% if user or isGuest %}
        <script src="{{ asset('js/client_appointment.js') }}"></script>
        <script>
            // Initialize appointment form with server data
            initializeAppointmentForm({
                appointments: {{ appointments|json_encode|raw }},
                today: '{{ today }}',
                barbers: {{ barbersData|json_encode|raw }},
                barberProcedureMap: {{ barberProcedureMap|json_encode|raw }}
            });
        </script>
    {% endif %}
{% endblock %}
