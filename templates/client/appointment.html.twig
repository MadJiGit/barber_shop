{% extends 'base.html.twig' %}

{% block title %}Запазете час - Barber Shop{% endblock %}

{% block body %}
    <!--? Hero Start -->
    <div class="slider-area2">
        <div class="slider-height2 d-flex align-items-center">
            <div class="container">
                <div class="row">
                    <div class="col-xl-12">
                        <div class="hero-cap hero-cap2 pt-70 text-center">
                            <h2>Запазете час</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Hero End -->

    <!--? Appointment Booking Section Start -->
    <section class="appointment-booking-section section-padding30">
        <div class="container">
            {% if user.email %}
                <div class="row justify-content-center">
                    <div class="col-xl-11 col-lg-12">
                        <!-- Section Title -->
                        <div class="section-tittle text-center mb-50">
                            <h2>Изберете часовия диапазон, в който желаете да запазите своя час.</h2>
                        </div>

                        <!-- Appointment Form -->
                        <form id="appointment_form"
                              method="post"
                              class="appointment-form-new"
                              data-turbo="false">
                            {{ form_row(form._token) }}

                            <!-- Hidden inputs for form submission -->
                            <input type="hidden" name="barbers" id="selected_barber_id" value=""/>
                            <input type="hidden" name="procedures" id="selected_procedure_id" value=""/>
                            <input type="hidden" name="appointment_start" id="selected_appointment_date" value="{{ today }}"/>
                            <input type="hidden" name="pickedHours" id="pickedHours" value=""/>

                            <div class="row">
                                <!-- Procedure Selection -->
                                <div class="col-lg-12 mb-40">
                                    <div class="form-section text-center">
                                        <h4 class="form-section-title justify-content-center">
                                            <i class="fas fa-cut"></i> Изберете услуга
                                        </h4>
                                        <div class="procedure-select-wrapper">
                                            <select name="procedure_select" id="procedure_select" class="custom-select-new" onchange="handleProcedureChange()">
                                                <option value="">Изберете услуга...</option>
                                                {% for procedure in procedures %}
                                                    <option value="{{ procedure.id }}"
                                                            data-duration-master="{{ procedure.durationMaster }}"
                                                            data-duration-junior="{{ procedure.durationJunior }}"
                                                            data-price-master="{{ procedure.priceMaster }}"
                                                            data-price-junior="{{ procedure.priceJunior }}"
                                                            data-procedure-name="{{ procedure.type }}">
                                                        {{ procedure.type }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Date Selection -->
                                <div class="col-lg-12 mb-40">
                                    <div class="form-section text-center">
                                        <h4 class="form-section-title mb-20">Дата:</h4>
                                        <div class="date-control-wrapper-new">
                                            <button class="date-arrow-btn-new" type="button" onclick="changeDate(-1)">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <input class="date-display-new"
                                                   type="text"
                                                   id="calendar_display"
                                                   value="{{ today|date('d-m-Y') }}"
                                                   autocomplete="off"
                                            />
                                            <button class="date-arrow-btn-new" type="button" onclick="changeDate(1)">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                        <div class="day-of-week-display" id="day_of_week">
                                            {% set dayNames = {0: 'Неделя', 1: 'Понеделник', 2: 'Вторник', 3: 'Сряда', 4: 'Четвъртък', 5: 'Петък', 6: 'Събота'} %}
                                            {{ dayNames[today|date('w')] }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Barbers with Time Slots -->
                                <div class="col-lg-12" id="barbers_container">
                                    {# Barber sections will be generated dynamically by JavaScript #}
                                    <div id="barbers-container">
                                        <div class="text-center text-muted p-4">
                                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                            <p>Зареждане на свободни часове...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="col-lg-12 text-center mt-50">
                                    <button type="submit"
                                            class="btn btn-primary btn-lg"
                                            id="submit_btn"
                                            disabled
                                            name="submit_appointment"
                                            value="1">
                                        <i class="fas fa-check"></i> Запази час
                                    </button>
                                    <div class="selection-summary mt-3" id="selection_summary">
                                        <small class="text-muted">Изберете услуга и час за да продължите</small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <!-- User needs to complete profile -->
                <div class="row justify-content-center">
                    <div class="col-lg-8 text-center">
                        <div class="alert alert-warning">
                            <h4>Завършете профила си</h4>
                            <p>Моля, попълнете информацията за профила си преди да запазите час.</p>
                            <a href="{{ path('profile_edit', {id: user.id}) }}" class="btn btn-primary mt-3">
                                Завърши профил
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>
    <!-- Appointment Booking Section End -->

{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/client_appointment.css') }}">
{% endblock %}


{% block javascripts %}
    {{ parent() }}
    {% if user.email %}
        <script src="{{ asset('js/client_appointment.js') }}"></script>
        <script>
            // Initialize appointment form with server data
            initializeAppointmentForm({
                appointments: {{ appointments|json_encode|raw }},
                today: '{{ today }}',
                barbers: {{ barbersData|json_encode|raw }},
                barberProcedureMap: {{ barberProcedureMap|json_encode|raw }}
            });
        </script>
    {% endif %}
{% endblock %}
